
# üì° API Reference - Sistema ERP Completo

Documentaci√≥n completa de todas las APIs REST disponibles en el sistema.

## üîê Autenticaci√≥n

Todas las APIs requieren autenticaci√≥n mediante NextAuth.js. Las rutas est√°n protegidas por rol de usuario.

### **Sistema de Roles**
- `SUPERADMIN`: Acceso completo
- `ADMIN`: Gesti√≥n de usuarios y configuraci√≥n
- `VENTAS`: Pedidos, ventas, clientes
- `GESTOR`: Cobranza, pagos, reestructuras
- `ANALISTA`: Reportes y consultas
- `CLIENTE`: Portal limitado

## üìã Endpoints Disponibles

### **üîë Autenticaci√≥n**

#### `POST /api/auth/signin`
Iniciar sesi√≥n en el sistema.
```json
{
  "email": "admin@erp.com",
  "password": "admin123"
}
```

#### `POST /api/auth/signout`
Cerrar sesi√≥n activa.

---

### **üë• Gesti√≥n de Usuarios**

#### `GET /api/users`
Obtener lista de usuarios del sistema.
```json
{
  "users": [
    {
      "id": "uuid",
      "name": "Admin User",
      "email": "admin@erp.com", 
      "role": "SUPERADMIN",
      "isActive": true
    }
  ]
}
```

#### `POST /api/users`
Crear nuevo usuario.
```json
{
  "name": "Nuevo Usuario",
  "email": "usuario@empresa.com",
  "password": "password123",
  "role": "VENTAS",
  "sucursal": "Principal"
}
```

---

### **üë§ Gesti√≥n de Clientes**

#### `GET /api/clientes`
Listar clientes con filtros opcionales.

**Query Parameters:**
- `search`: B√∫squeda por nombre/c√≥digo
- `status`: Filtrar por estado (ACTIVO, INACTIVO, MOROSO)
- `gestorId`: Filtrar por gestor asignado

```json
{
  "clientes": [
    {
      "id": "uuid",
      "codigoCliente": "CLI-001",
      "nombre": "Cliente Ejemplo",
      "telefono1": "5555551234",
      "email": "cliente@email.com",
      "saldoActual": 15000.00,
      "limiteCredito": 50000.00,
      "status": "ACTIVO"
    }
  ]
}
```

#### `POST /api/clientes`
Crear nuevo cliente.
```json
{
  "codigoCliente": "CLI-002", 
  "nombre": "Nuevo Cliente SA de CV",
  "telefono1": "5555559999",
  "email": "nuevo@cliente.com",
  "calle": "Av. Ejemplo 123",
  "colonia": "Centro",
  "municipio": "Ciudad",
  "estado": "Estado",
  "codigoPostal": "12345",
  "limiteCredito": 25000.00
}
```

#### `GET /api/clientes/[id]`
Obtener cliente espec√≠fico con detalles completos.

#### `PUT /api/clientes/[id]`
Actualizar informaci√≥n del cliente.

#### `POST /api/clientes/import`
Importar clientes desde CSV.

---

### **üì¶ Gesti√≥n de Productos**

#### `GET /api/productos`
Listar productos del cat√°logo.

**Query Parameters:**
- `search`: B√∫squeda por c√≥digo/nombre
- `categoria`: Filtrar por categor√≠a
- `marca`: Filtrar por marca
- `activo`: Solo productos activos

```json
{
  "productos": [
    {
      "id": "uuid",
      "codigo": "PROD-001",
      "nombre": "Producto Ejemplo",
      "descripcion": "Descripci√≥n del producto",
      "categoria": "Electr√≥nicos",
      "marca": "Marca X",
      "precio1": 100.00,
      "precio2": 90.00,
      "precio3": 85.00,
      "stock": 50,
      "stockMinimo": 10,
      "isActive": true
    }
  ]
}
```

#### `POST /api/productos`
Crear nuevo producto.
```json
{
  "codigo": "PROD-002",
  "nombre": "Nuevo Producto",
  "descripcion": "Descripci√≥n detallada",
  "categoria": "Herramientas", 
  "marca": "Marca Y",
  "precio1": 150.00,
  "precioCompra": 100.00,
  "stock": 25,
  "stockMinimo": 5,
  "stockMaximo": 100
}
```

#### `GET /api/productos/[id]`
Obtener producto espec√≠fico.

#### `PUT /api/productos/[id]`
Actualizar informaci√≥n del producto.

---

### **üìù Sistema de Pedidos**

#### `GET /api/pedidos`
Listar pedidos con filtros.

**Query Parameters:**
- `clienteId`: Pedidos de cliente espec√≠fico
- `vendedorId`: Pedidos de vendedor espec√≠fico
- `estatus`: PENDIENTE, APROBADO, CONVERTIDO_VENTA

```json
{
  "pedidos": [
    {
      "id": "uuid",
      "folio": "PED-001",
      "cliente": {
        "nombre": "Cliente Ejemplo",
        "codigoCliente": "CLI-001"
      },
      "vendedor": {
        "name": "Vendedor 1"
      },
      "subtotal": 1000.00,
      "iva": 160.00,
      "total": 1160.00,
      "estatus": "PENDIENTE",
      "fechaPedido": "2024-01-15T10:30:00Z"
    }
  ]
}
```

#### `POST /api/pedidos`
Crear nuevo pedido.
```json
{
  "clienteId": "uuid",
  "vendedorId": "uuid",
  "observaciones": "Pedido urgente",
  "detalles": [
    {
      "productoId": "uuid",
      "cantidad": 2,
      "precioUnitario": 100.00
    }
  ]
}
```

#### `POST /api/pedidos/[id]/convertir-venta`
Convertir pedido a venta con generaci√≥n autom√°tica de pagar√©s.
```json
{
  "pagoInicial": 200.00,
  "periodicidadPago": "SEMANAL",
  "montoPago": 150.00,
  "fechaProximoPago": "2024-01-22"
}
```

---

### **üí∞ Sistema de Ventas**

#### `GET /api/ventas`
Listar ventas realizadas.

**Query Parameters:**
- `clienteId`: Ventas de cliente espec√≠fico
- `fechaInicio`: Filtro por fecha inicial
- `fechaFin`: Filtro por fecha final
- `status`: Estado de la venta

```json
{
  "ventas": [
    {
      "id": "uuid",
      "folio": "VENTA-001", 
      "numeroFactura": "A-123",
      "cliente": {
        "nombre": "Cliente Ejemplo"
      },
      "subtotal": 1000.00,
      "iva": 160.00,
      "total": 1160.00,
      "pagoInicial": 200.00,
      "saldoPendiente": 960.00,
      "status": "CONFIRMADA",
      "fechaVenta": "2024-01-15T14:30:00Z"
    }
  ]
}
```

#### `POST /api/ventas`
Crear nueva venta directamente.

#### `GET /api/ventas/[id]`
Obtener venta espec√≠fica con detalles y pagar√©s.

---

### **üìÑ Sistema de Pagar√©s**

#### `GET /api/pagares`
Listar pagar√©s del sistema.

**Query Parameters:**
- `clienteId`: Pagar√©s de cliente espec√≠fico
- `estatus`: PENDIENTE, VENCIDO, PAGADO
- `fechaVencimiento`: Filtrar por fecha de vencimiento

```json
{
  "pagares": [
    {
      "id": "uuid",
      "venta": {
        "folio": "VENTA-001",
        "cliente": {
          "nombre": "Cliente Ejemplo"
        }
      },
      "numeroPago": 1,
      "monto": 240.00,
      "fechaVencimiento": "2024-01-22T00:00:00Z",
      "montoPagado": 0.00,
      "diasVencido": 0,
      "interesesMora": 0.00,
      "estatus": "PENDIENTE"
    }
  ]
}
```

#### `POST /api/pagares/calcular-intereses`
Calcular intereses de mora para pagar√©s vencidos.
```json
{
  "fechaCorte": "2024-01-30",
  "tasaInteres": 3.0
}
```

#### `POST /api/pagares/[id]/aplicar-pago`
Aplicar pago a pagar√© espec√≠fico.
```json
{
  "montoPago": 240.00,
  "fechaPago": "2024-01-22",
  "tipoPago": "EFECTIVO",
  "referencia": "PAG-001"
}
```

---

### **üìã Notas de Cargo**

#### `GET /api/notas-cargo`
Listar notas de cargo.

**Query Parameters:**
- `clienteId`: Notas de cliente espec√≠fico
- `estado`: pendiente, aplicada

```json
{
  "notasCargo": [
    {
      "id": "uuid",
      "folio": "NC-000001",
      "cliente": {
        "nombre": "Cliente Ejemplo"
      },
      "concepto": "INTERESES_MORA",
      "descripcion": "Intereses por pago tard√≠o",
      "monto": 150.00,
      "aplicada": false,
      "fecha": "2024-01-20T10:00:00Z"
    }
  ]
}
```

#### `POST /api/notas-cargo`
Crear nota de cargo.
```json
{
  "clienteId": "uuid",
  "ventaId": "uuid",
  "concepto": "GASTOS_COBRANZA",
  "descripcion": "Gastos de gesti√≥n de cobranza",
  "monto": 100.00,
  "referencia": "REF-001"
}
```

#### `POST /api/notas-cargo/[id]/aplicar`
Aplicar nota de cargo (actualiza saldo del cliente).

---

### **üí≥ Notas de Cr√©dito**

#### `GET /api/notas-credito`
Listar notas de cr√©dito.

```json
{
  "notasCredito": [
    {
      "id": "uuid",
      "folio": "NCR-000001",
      "cliente": {
        "nombre": "Cliente Ejemplo"
      },
      "concepto": "DEVOLUCION_MERCANCIA",
      "descripcion": "Devoluci√≥n de producto defectuoso",
      "monto": 300.00,
      "afectaInventario": true,
      "aplicada": false,
      "detalles": [
        {
          "producto": {
            "codigo": "PROD-001",
            "nombre": "Producto Ejemplo"
          },
          "cantidad": 2,
          "precioUnitario": 150.00,
          "subtotal": 300.00
        }
      ]
    }
  ]
}
```

#### `POST /api/notas-credito`
Crear nota de cr√©dito.
```json
{
  "clienteId": "uuid",
  "concepto": "DEVOLUCION_MERCANCIA",
  "descripcion": "Producto defectuoso",
  "monto": 300.00,
  "afectaInventario": true,
  "detalles": [
    {
      "productoId": "uuid",
      "cantidad": 2,
      "precioUnitario": 150.00,
      "subtotal": 300.00,
      "motivo": "Producto defectuoso"
    }
  ]
}
```

#### `POST /api/notas-credito/[id]/aplicar`
Aplicar nota de cr√©dito (reduce saldo cliente, actualiza inventario).

---

### **üîÑ Reestructuras de Cr√©dito**

#### `GET /api/reestructuras`
Listar reestructuras de cr√©dito.

```json
{
  "reestructuras": [
    {
      "id": "uuid", 
      "cliente": {
        "nombre": "Cliente Ejemplo"
      },
      "venta": {
        "folio": "VENTA-001"
      },
      "saldoAnterior": 5000.00,
      "saldoNuevo": 4500.00,
      "montoPagoAnterior": 250.00,
      "montoPagoNuevo": 200.00,
      "periodicidadNueva": "QUINCENAL",
      "motivo": "DIFICULTADES_ECONOMICAS",
      "descuentoOtorgado": 500.00,
      "fechaReestructura": "2024-01-25T09:00:00Z"
    }
  ]
}
```

#### `POST /api/reestructuras`
Crear reestructura de cr√©dito.
```json
{
  "ventaId": "uuid",
  "clienteId": "uuid",
  "motivo": "PERDIDA_EMPLEO",
  "periodicidadNueva": "MENSUAL",
  "montoPagoNuevo": 180.00,
  "numeroPagosNuevo": 25,
  "fechaProximoPagoNueva": "2024-02-01",
  "descuentoOtorgado": 300.00,
  "observaciones": "Cliente perdi√≥ empleo, se otorga facilidad de pago"
}
```

---

### **üõ°Ô∏è Sistema de Garant√≠as**

#### `GET /api/garantias`
Listar garant√≠as registradas.

**Query Parameters:**
- `clienteId`: Garant√≠as de cliente espec√≠fico
- `estatus`: ACTIVA, RECLAMADA, EN_PROCESO, RESUELTA
- `vigente`: true para solo garant√≠as vigentes

```json
{
  "garantias": [
    {
      "id": "uuid",
      "folio": "GAR-000001",
      "cliente": {
        "nombre": "Cliente Ejemplo"
      },
      "producto": {
        "codigo": "PROD-001",
        "nombre": "Laptop Dell"
      },
      "tipoGarantia": "FABRICANTE",
      "fechaCompra": "2024-01-15",
      "fechaFinGarantia": "2025-01-15",
      "mesesGarantia": 12,
      "estatus": "ACTIVA",
      "descripcionFalla": null
    }
  ]
}
```

#### `POST /api/garantias`
Registrar nueva garant√≠a.
```json
{
  "clienteId": "uuid",
  "ventaId": "uuid", 
  "productoId": "uuid",
  "tipoGarantia": "TIENDA",
  "mesesGarantia": 6,
  "fechaCompra": "2024-01-15",
  "descripcionFalla": "Pantalla no enciende"
}
```

#### `POST /api/garantias/[id]/procesar`
Procesar reclamo de garant√≠a.
```json
{
  "accion": "REEMPLAZAR",
  "diagnostico": "Placa madre da√±ada por humedad",
  "solucionAplicada": "Reemplazo de equipo completo",
  "productoReemplazoId": "uuid",
  "costoReemplazo": 15000.00
}
```

---

### **üìä Dashboard y Analytics**

#### `GET /api/dashboard/stats`
Obtener estad√≠sticas b√°sicas del dashboard.
```json
{
  "totalClientes": 150,
  "totalProductos": 1200,
  "ventasHoy": 25000.00,
  "cobranzaHoy": 18000.00,
  "saldoPendiente": 450000.00,
  "pagaresPendientes": 325
}
```

#### `GET /api/dashboard/analytics`
Obtener an√°lisis avanzado para gr√°ficos.

**Query Parameters:**
- `periodo`: N√∫mero de meses a analizar (3, 6, 12)

```json
{
  "periodo": 6,
  "ventasPorMes": [
    {
      "mes": "2024-01-01T00:00:00Z", 
      "total_ventas": "125000.00",
      "cantidad_ventas": "45",
      "saldo_pendiente": "75000.00"
    }
  ],
  "cobranzaPorMes": [...],
  "topProductos": [...],
  "topClientes": [...],
  "carteraVencida": [...],
  "garantiasAnalysis": [...],
  "reestructurasAnalysis": [...]
}
```

---

### **üìà Sistema de Reportes**

#### `GET /api/reportes/ventas`
Generar reporte de ventas.

**Query Parameters:**
- `fechaInicio`: Fecha inicial del reporte
- `fechaFin`: Fecha final del reporte
- `clienteId`: Cliente espec√≠fico (opcional)
- `vendedorId`: Vendedor espec√≠fico (opcional)
- `formato`: json o csv

```json
{
  "ventas": [...],
  "resumen": {
    "totalVentas": 45,
    "montoTotal": 125000.00,
    "montoCobrado": 75000.00,
    "saldoPendiente": 50000.00,
    "promedioVenta": 2777.78
  },
  "ventasPorVendedor": {...},
  "ventasPorProducto": {...}
}
```

#### `GET /api/reportes/cobranza`
Generar reporte de cobranza.

**Query Parameters:**
- `tipo`: pagos, pagares, cartera
- `fechaInicio`, `fechaFin`: Rango de fechas
- `gestorId`: Gestor espec√≠fico (opcional)
- `formato`: json o csv

#### `GET /api/reportes/inventario` 
Generar reporte de inventario.

**Query Parameters:**
- `tipo`: stock, movimientos, valoracion
- `categoria`, `marca`: Filtros opcionales
- `formato`: json o csv

---

### **‚öôÔ∏è Configuraci√≥n del Sistema**

#### `GET /api/configuracion`
Obtener configuraci√≥n actual del sistema.
```json
{
  "id": "uuid",
  "nombreEmpresa": "Mi Empresa SA",
  "colorPrimario": "#3B82F6",
  "colorSecundario": "#10B981", 
  "direccion": "Av. Principal 123",
  "telefono": "5555551234",
  "email": "contacto@empresa.com",
  "rfc": "EMP123456789",
  "configJson": {
    "iva": 16,
    "monedaDefecto": "MXN",
    "configuracionCobranza": {
      "tasaInteresDefecto": 3.0,
      "diasGraciaDefecto": 0
    },
    "integraciones": {...}
  }
}
```

#### `PUT /api/configuracion`
Actualizar configuraci√≥n del sistema (requiere rol ADMIN o SUPERADMIN).

---

### **üîå Integraciones Externas**

#### `POST /api/integraciones/webhooks`
Recibir webhooks de servicios externos.

**Query Parameters:**
- `tipo`: pago, facturacion, inventario
- `origen`: openpay, stripe, pac, etc.

#### `POST /api/integraciones/sync`
Sincronizar datos con sistemas externos.
```json
{
  "tipo": "exportar_clientes",
  "destino": "contabilidad",
  "datos": {
    "fechaDesde": "2024-01-01"
  }
}
```

---

## üîÑ C√≥digos de Respuesta HTTP

- **200**: √âxito
- **201**: Creado exitosamente
- **400**: Error en los datos enviados
- **401**: No autorizado
- **403**: Sin permisos suficientes
- **404**: Recurso no encontrado
- **500**: Error interno del servidor

## üìù Formato de Errores

```json
{
  "error": "Descripci√≥n del error",
  "code": "ERROR_CODE",
  "details": {
    "field": "Campo espec√≠fico con error",
    "message": "Mensaje detallado"
  }
}
```

## üß™ Ejemplos de Uso

### **Flujo Completo: Pedido ‚Üí Venta ‚Üí Cobranza**

```javascript
// 1. Crear pedido
const pedido = await fetch('/api/pedidos', {
  method: 'POST',
  body: JSON.stringify({
    clienteId: 'cliente-uuid',
    vendedorId: 'vendedor-uuid',
    detalles: [...]
  })
});

// 2. Convertir a venta
const venta = await fetch(`/api/pedidos/${pedido.id}/convertir-venta`, {
  method: 'POST', 
  body: JSON.stringify({
    pagoInicial: 500.00,
    periodicidadPago: 'SEMANAL',
    montoPago: 250.00
  })
});

// 3. Aplicar pago
const pago = await fetch(`/api/pagares/${pagareId}/aplicar-pago`, {
  method: 'POST',
  body: JSON.stringify({
    montoPago: 250.00,
    tipoPago: 'EFECTIVO'
  })
});
```

---

> üìö **Documentaci√≥n completa**: Ver [Manual de Usuario](./USER_MANUAL.md) para ejemplos de uso desde la interfaz web.

